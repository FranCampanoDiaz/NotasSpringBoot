<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>NoteApp</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <meta name="_csrf" content="${_csrf.token}">
    <meta name="_csrf_header" content="${_csrf.headerName}">

</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative flex h-auto min-h-screen w-full flex-col">
    <div class="flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-primary/20 dark:border-primary/30 px-6 md:px-10 py-4">
            <div class="flex items-center gap-3 text-slate-900 dark:text-white">

                <div class="text-primary size-8">
                    <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 2H8C4.691 2 2 4.691 2 8v13h2V8c0-2.556 1.913-4.665 4.394-4.943A4.992 4.992 0 0 1 8 3h8c2.206 0 4 1.794 4 4v12c0 1.103-.897 2-2 2H8v-2h8c-1.103 0-2-.897-2-2V7c0-1.103-.897-2-2-2H8c-.566 0-1.093.242-1.465.649A5.023 5.023 0 0 1 5.95 6.05C6.016 6.033 6.082 6.018 6.149 6H8v15H6V8c0-1.103-.897-2-2-2s-2 .897-2 2v13a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8c0-3.309-2.691-6-6-6z"></path>
                    </svg>
                </div>
                <span onclick="fetchNotes()" class="text-xl font-bold cursor-pointer">NoteApp</span>
            </div>
            <div class="flex justify-center gap-4 flex-grow">
                <input id="searchInput" type="text" placeholder="Buscar por título..."
                       class="p-2 border border-gray-300 rounded w-48 text-sm"/>
                <button onclick="searchNote()"
                        class="p-2 rounded-full hover:bg-primary/10 dark:hover:bg-primary/20 text-slate-600 dark:text-slate-300">
                    <span class="material-symbols-outlined">search</span>
                </button>

            </div>
            <form action="/logout" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit"
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded transition duration-200 shadow-md hover:shadow-lg rounded-lg">
                    LogOut
                </button>
            </form>
        </header>
        <main class="flex-1 w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6">My Notes</h2>
            <div id="notes-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

            </div>
        </main>
    </div>
    <button id="addNoteBtn"
            class="fixed bottom-8 right-8 bg-primary text-white rounded-full h-14 w-14 flex items-center justify-center shadow-lg hover:bg-primary/90 transition-colors">
        <span class="material-symbols-outlined text-3xl">add</span>
    </button>
</div>

<script>
    async function apiFetch(url, method = 'GET', body = null) {
    const csrfToken = document.querySelector('input[name="_csrf"]')?.value;

    const options = {
        method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': csrfToken || ''
        }
    };

    if (body) options.body = JSON.stringify(body);

    try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        // Si hay contenido JSON, devuélvelo; si no, null
        const contentType = res.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return await res.json();
        }
        return null;
    } catch (err) {
        console.error('Error en la petición:', err);
        throw err;
    }
}

</script>

<script>
    //metodo para traer las notas de la API.
    async function fetchNotes() {
        try {
        const notes = await apiFetch('/api/notas');
            renderNotes(notes);

            // Limpiar el input de búsqueda cuando cargue todas las notas
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }

        } catch (error) {
            console.error('Error al cargar notas:', error);
        }
    }

    //metodo para borrar una nota
    async function deleteNote(id, button) {
        if (!confirm("¿Estás seguro que quiere eliminar la nota?")) return;
<!-- TODO: Corregir -->
        try {
        await apiFetch(`/api/notas/${id}`, 'DELETE');
        button.closest('div.bg-white' || 'div.bg.green-50')?.remove();
        showToast("Nota eliminada correctamente");
        } catch (error) {
            console.error(error);
        }

    }

    //modificar nota.
    async function editNote(id) {
        try {
            const note = await apiFetch(`/api/notas/${id}`);

            // Rellena el formulario con los datos existentes
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteDescription').value = note.description;
            document.getElementById('noteCompleted').checked = note.completed;

            // Guarda el ID de la nota que se está editando
            editingNoteId = id;

            // Cambia el título del modal
            document.querySelector('#modal h3').textContent = 'Editar Nota';

            // Muestra el modal
            document.getElementById('modal').classList.remove('hidden');
        } catch (error) {
            console.error('Error al cargar la nota:', error);
            showToast('No se pudo cargar la nota para editar.');
        }
    }

    //metodo para mostrar las notas visualmente.
    function renderNotes(notes) {
        const container = document.getElementById('notes-container');
        container.innerHTML = '';

        if (notes.length === 0) {
            container.innerHTML = '<p class="text-gray-500 ">No hay notas disponibles.</p>';
            return;
        }

        notes.forEach(note => {
            const card = document.createElement('div');
            card.className = `
          bg-white p-6 rounded-lg shadow-md border-l-4 hover:shadow-lg
          ${note.completed ? 'border-green-500 bg-green-50 hover:border-green-500' : 'border-yellow-500'}
        `;

            card.innerHTML = `
  <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">${note.title}</h3>
  <p class="text-gray-600 dark:text-gray-300 mb-4">${note.description}</p>
  <p class="text-sm mb-4">
    <span class="font-medium">Estado:</span>
    <span class="${note.completed ? 'text-green-700' : 'text-yellow-700'} font-semibold">
      ${note.completed ? 'Completada' : 'Pendiente'}
    </span>
  </p>

    <div class="flex justify-end gap-2 mt-auto pt-2">
      <button onclick="editNote(${note.id})" title="Editar" class="bg-primary text-white text-xs px-2 py-1 rounded hover:bg-blue-600 transition-colors duration-200">
        <span class="material-symbols-outlined text-base leading-none">edit</span>
      </button>
      <button onclick="deleteNote(${note.id},this)" title="Eliminar" class="bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600 transition-colors duration-200">
        <span class="material-symbols-outlined text-base leading-none">delete</span>
      </button>
    </div>
  </div>
`;


            container.appendChild(card);
        });
    }

    //metodo para buscar nota
    async function searchNote() {
        const query = document.getElementById('searchInput').value.trim();

        if (query === "") {
            fetchNotes(); // Si no hay texto, muestra todas las notas
            return;
        }

        try {
            const notes = await apiFetch(`/api/notas/search?title=${encodeURIComponent(query)}`);
            renderNotes(notes);

            if (notes.length === 0) {
                showToast("No se encontraron notas con ese título");
            }

        } catch (error) {
            showToast('Hubo un error al buscar las notas.');
        }
    }


    fetchNotes();
</script>


<script>
    //variable para saber si edito o creo.
    let editingNoteId = null;
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('modal');
        const addBtn = document.getElementById('addNoteBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const createNoteForm = document.getElementById('createNoteForm');

        addBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });

        cancelBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            createNoteForm.reset();
            editingNoteId = null; // vuelve a modo creación
            document.querySelector('#modal h3').textContent = 'Crear Nueva Nota';
        });

        createNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const newNote = {
                title: document.getElementById('noteTitle').value,
                description: document.getElementById('noteDescription').value,
                completed: document.getElementById('noteCompleted').checked
            };
            // Tomar el token CSRF del input oculto


            try {
                const url = editingNoteId ? `/api/notas/${editingNoteId}` : '/api/notas';
                const method = editingNoteId ? 'PUT' : 'POST';
                await apiFetch(url, method, newNote);
                showToast(editingNoteId ? 'Nota actualizada' : 'Nota creada');
                modal.classList.add('hidden');
                createNoteForm.reset();
                editingNoteId = null;
                document.querySelector('#modal h3').textContent = 'Crear Nueva Nota';
                fetchNotes();
     } catch (error) {
                console.error(error);
                showToast('Error al guardar la nota');
            }
        });

    });
</script>


<!-- Modal para crear nueva nota oculto por defecto -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-background-dark rounded-lg p-6 w-96 shadow-lg">
        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Crear Nueva Nota</h3>
        <form id="createNoteForm" class="flex flex-col gap-4">
            <input type="text" id="noteTitle" placeholder="Título" required
                   class="p-2 border border-gray-300 rounded"/>
            <textarea id="noteDescription" placeholder="Descripción" rows="4" required
                      class="p-2 border border-gray-300 rounded"></textarea>
            <label class="flex items-center gap-2">
                <input type="checkbox" id="noteCompleted"/>
                <span class="text-gray-700 dark:text-gray-300">Completada</span>
            </label>
            <div class="flex justify-end gap-2">
                <button type="button" id="cancelBtn"
                        class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancelar
                </button>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit"
                        class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function showToast(message) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');

        toast.className = `
            bg-black text-white px-4 py-2 rounded shadow
            animate-fade-in-up
        `;
        toast.textContent = message;

        container.appendChild(toast);

        // Desaparece después de 3 segundos
        setTimeout(() => {
            toast.classList.add('animate-fade-out');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // Animaciones
    const style = document.createElement('style');
    style.innerHTML = `
    @keyframes fade-in-up { from { opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
    @keyframes fade-out { from { opacity:1; transform: translateY(0);} to {opacity:0; transform: translateY(-10px);} }
    .animate-fade-in-up { animation: fade-in-up 0.3s ease-out; }
    .animate-fade-out { animation: fade-out 0.5s ease-in forwards; }
    `;
    document.head.appendChild(style);
</script>




<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#137fec",
                    "background-light": "#f6f7f8",
                    "background-dark": "#101922",
                },
                fontFamily: {
                    "display": ["Inter"]
                },
                borderRadius: {
                    "DEFAULT": "0.25rem",
                    "lg": "0.5rem",
                    "xl": "0.75rem",
                    "full": "9999px"
                },
            },
        },
    }
</script>

function showConfirmToast(message, onConfirm, onCancel) {
// Crear el contenedor del toast
const toast = document.createElement("div");
toast.className = `
fixed top-1/2 left-1/2
transform -translate-x-1/2 -translate-y-1/2
bg-black text-white px-6 py-4 rounded shadow
flex flex-col items-center space-y-2 animate-fade-in-up
`;

// Mensaje
const text = document.createElement("div");
text.textContent = message;
toast.appendChild(text);

// Contenedor de botones
const btnContainer = document.createElement("div");
btnContainer.className = "flex space-x-2";

// Botón confirmar
const confirmBtn = document.createElement("button");
confirmBtn.textContent = "Sí";
confirmBtn.className = "bg-green-500 px-4 py-1 rounded hover:bg-green-600";
confirmBtn.onclick = () => {
toast.remove();
if (onConfirm) onConfirm();
};

// Botón cancelar
const cancelBtn = document.createElement("button");
cancelBtn.textContent = "No";
cancelBtn.className = "bg-red-500 px-4 py-1 rounded hover:bg-red-600";
cancelBtn.onclick = () => {
toast.remove();
if (onCancel) onCancel();
};

btnContainer.appendChild(confirmBtn);
btnContainer.appendChild(cancelBtn);
toast.appendChild(btnContainer);

document.body.appendChild(toast);
}



<div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>
</body>
</html>
